name: Deploy to Contabo

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ“ Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ’¾ Backup Database (Pre-Deploy)
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
            echo "ğŸ“¦ Creating database backup..."
            mkdir -p /backups
          
            # Backup with timestamp
            BACKUP_FILE="/backups/warehouse_$(date +%Y%m%d_%H%M%S).sql"
          
            docker exec warehouse_postgres pg_dump \
              -U warehouse_user WareHouseManagementDb > "$BACKUP_FILE"
          
            echo "âœ… Backup created: $BACKUP_FILE"
          
            # Keep only last 7 days of backups
            find /backups -name "warehouse_*.sql" -mtime +7 -delete
          
            echo "ğŸ—‘ï¸ Old backups cleaned up"
          ENDSSH

      - name: ğŸš€ Deploy to server
        id: deploy
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
            set -e
          
            echo "ğŸ“‚ Navigating to project..."
            cd /var/www/WareHouseManagement
          
            # Save current commit for rollback
            CURRENT_COMMIT=$(git rev-parse HEAD)
            echo "$CURRENT_COMMIT" > /tmp/last_successful_commit
            echo "ğŸ’¾ Current commit saved: $CURRENT_COMMIT"
          
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin master
          
            NEW_COMMIT=$(git rev-parse HEAD)
            echo "ğŸ†• New commit: $NEW_COMMIT"
          
            echo "ğŸ³ Rebuilding Docker containers..."
            docker compose build api
          
            echo "â™»ï¸ Restarting containers..."
            docker compose up -d
          
            echo "â³ Waiting for containers to start..."
            sleep 15
          
            echo "âœ… Checking container status..."
            docker ps | grep warehouse
          ENDSSH

      - name: ğŸ¥ Health Check
        id: health_check
        run: |
          echo "ğŸ” Performing health check..."
          
          # Try health check up to 5 times
          for i in {1..5}; do
            echo "Attempt $i/5..."
          
            if curl -f -s http://${{ secrets.SSH_HOST }}:5000/health > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              exit 0
            fi
          
            echo "â³ Waiting 10 seconds before retry..."
            sleep 10
          done
          
          echo "âŒ Health check failed after 5 attempts"
          exit 1

      - name: ğŸ”„ Rollback on Failure
        if: failure() && steps.deploy.conclusion == 'success'
        run: |
          echo "âš ï¸ Deployment failed! Rolling back..."
          
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
            set -e
          
            cd /var/www/WareHouseManagement
          
            # Get last successful commit
            if [ -f /tmp/last_successful_commit ]; then
              LAST_COMMIT=$(cat /tmp/last_successful_commit)
              echo "ğŸ”„ Rolling back to commit: $LAST_COMMIT"
          
              git reset --hard "$LAST_COMMIT"
          
              echo "ğŸ³ Rebuilding with old version..."
              docker compose build api
              docker compose up -d
          
              echo "â³ Waiting for rollback to complete..."
              sleep 15
          
              echo "âœ… Rollback completed"
            else
              echo "âš ï¸ No previous commit found, restarting current version..."
              docker compose restart api
            fi
          ENDSSH
          
          echo "âŒ Deployment rolled back due to health check failure"
          exit 1

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "ğŸ“‹ Deployment Summary:"
          echo "===================="
          
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
            cd /var/www/WareHouseManagement
          
            echo "ğŸ“¦ Current commit:"
            git log -1 --oneline
          
            echo ""
            echo "ğŸ³ Container status:"
            docker ps --filter name=warehouse --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
            echo ""
            echo "ğŸ’¾ Recent backups:"
            ls -lht /backups/*.sql 2>/dev/null | head -3 || echo "No backups found"
          
            echo ""
            echo "ğŸ“Š Container logs (last 10 lines):"
            docker logs --tail 10 warehouse_api
          ENDSSH

      - name: ğŸ‰ Success Notification
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸŒ API: http://${{ secrets.SSH_HOST }}:5000/swagger"
          echo "ğŸ“Š Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ By: ${{ github.actor }}"